<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D4AF37">
  <title>Photography Sessions</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@200;300;400;500&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --bg-primary: #0a0a0a;
      --bg-card: rgba(232, 213, 183, 0.02);
      --text-primary: #E8D5B7;
      --text-secondary: rgba(232, 213, 183, 0.4);
      --gold: #E8D5B7;
      --border: rgba(232, 213, 183, 0.1);
      --critical: #ff6b6b;
      --limited: #ffa94d;
      --available: #95c97a;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
      line-height: 1.6;
    }
    
    h1, h2, .detail-header h2 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      letter-spacing: 0.1em;
    }
    
    .view {
      display: none;
      min-height: 100vh;
      padding: 32px 20px;
    }
    
    .view.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    #widget-view {
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .widget-header {
      margin-bottom: 48px;
      text-align: center;
    }
    
    .widget-header h1 {
      font-size: 36px;
      font-weight: 200;
      color: var(--gold);
      margin-bottom: 12px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    
    .widget-subtitle {
      font-size: 10px;
      color: var(--text-secondary);
      letter-spacing: 0.3em;
      text-transform: uppercase;
      font-weight: 300;
    }
    
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
    }
    
    .filter-select {
      flex: 1;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 2px;
      font-size: 11px;
      font-family: inherit;
      letter-spacing: 0.05em;
    }
    
    #widget-sessions {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    .card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(232, 213, 183, 0.01) 100%);
      border-radius: 4px;
      padding: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(232, 213, 183, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-client {
      font-family: 'Cormorant Garamond', serif;
      font-size: 22px;
      font-weight: 300;
      letter-spacing: 0.05em;
    }
    
    .card-countdown {
      font-size: 10px;
      font-weight: 600;
      padding: 8px 14px;
      border-radius: 2px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    
    .card-info {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      letter-spacing: 0.05em;
      font-weight: 300;
    }
    
    .card-date {
      font-size: 10px;
      color: rgba(232, 213, 183, 0.6);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 400;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      font-size: 11px;
      letter-spacing: 0.1em;
    }
    
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    
    .list-header h2 {
      font-size: 28px;
      font-weight: 300;
      color: var(--gold);
      letter-spacing: 0.1em;
    }
    
    .btn-add {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(232, 213, 183, 0.01) 100%);
      color: var(--gold);
      border: none;
      padding: 10px 16px;
      border-radius: 2px;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn-add:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(232, 213, 183, 0.1);
    }
    
    .list-item {
      background: var(--bg-card);
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.3s;
    }
    
    .list-item:active {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(232, 213, 183, 0.08);
    }
    
    .list-item-left h3 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 18px;
      font-weight: 300;
      color: var(--text-primary);
      margin-bottom: 6px;
      letter-spacing: 0.05em;
    }
    
    .list-item-left p {
      font-size: 11px;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
    }
    
    .list-item-right {
      text-align: right;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 6px 12px;
      border-radius: 2px;
    }
    
    .back-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 20px;
      border-radius: 2px;
      font-size: 11px;
      cursor: pointer;
      margin-bottom: 24px;
      transition: all 0.2s;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    
    .back-btn:active {
      background: var(--bg-card);
    }
    
    #detail-view {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .detail-header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .detail-header h2 {
      font-size: 28px;
      margin-bottom: 12px;
      font-weight: 300;
      letter-spacing: 0.05em;
    }
    
    .date {
      color: rgba(232, 213, 183, 0.6);
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }
    
    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 2px;
      margin-top: 12px;
      font-size: 11px;
      letter-spacing: 0.05em;
    }
    
    .section {
      margin-bottom: 32px;
    }
    
    .section-header {
      font-size: 10px;
      color: var(--text-secondary);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 16px;
      font-weight: 400;
    }
    
    .info-card {
      background: var(--bg-card);
      border-radius: 4px;
      padding: 16px 20px;
      margin-bottom: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .half-width {
      flex: 0 0 calc(50% - 6px);
      max-width: calc(50% - 6px);
    }
    
    .info-label {
      font-size: 9px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 6px;
    }
    
    .info-value {
      font-size: 13px;
      color: var(--text-primary);
      letter-spacing: 0.03em;
    }
    
    .info-value a {
      color: var(--gold);
      text-decoration: none;
    }
    
    .editable {
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .editable:hover {
      opacity: 0.7;
    }
    
.todo-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  background: var(--bg-card);
  padding: 14px 18px;
  border-radius: 4px;
  margin-bottom: 10px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
  letter-spacing: 0.03em;
}

.todo-text {
  flex: 1;
}

.hide-btn {
  background: rgba(232, 213, 183, 0.08);
  color: var(--gold);
  border: none;
  padding: 6px 10px;
  border-radius: 2px;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  transition: all 0.2s ease;
  opacity: 0.7;
  flex-shrink: 0;
}

.hide-btn:hover {
  opacity: 1;
  background: rgba(232, 213, 183, 0.15);
  transform: translateX(-2px);
}
    
    .todo-item:active {
      transform: scale(0.98);
    }
    
    .todo-item.completed {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 4px;
      margin-bottom: 12px;
    }
    
    .toggle-icon {
      transition: transform 0.3s;
      font-size: 14px;
    }
    
    .toggle-icon.expanded {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.expanded {
      max-height: 2000px;
    }
    
    .form-input {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 12px;
      border-radius: 2px;
      font-size: 13px;
      font-family: inherit;
    }
    
    .form-textarea {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 12px;
      border-radius: 2px;
      font-size: 13px;
      font-family: inherit;
      min-height: 100px;
      resize: vertical;
    }
    
    .toggle-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 14px 24px;
      border-radius: 4px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
      font-size: 12px;
      letter-spacing: 0.05em;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 20px;
      letter-spacing: 0.05em;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 2px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--gold);
      color: var(--bg-primary);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <!-- Widget View -->
  <div id="widget-view" class="view active">
    <div class="widget-header">
      <h1>Sessions</h1>
    </div>
    
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
      <button class="btn-add" onclick="showAddClient()">New Client</button>
    </div>
    
    <div class="filter-bar">
      <select id="widget-filter-phase" class="filter-select" onchange="applyFilters()">
        <option value="">All Phases</option>
      </select>
      <select id="widget-filter-type" class="filter-select" onchange="applyFilters()">
        <option value="">All Types</option>
      </select>
    </div>
    <div id="widget-sessions">
      <div class="loading">
        <div>Loading sessions...</div>
      </div>
    </div>
    <div class="widget-footer">
      Tap a session for details
    </div>
  </div>
  
  <!-- Detail View -->
  <div id="detail-view" class="view">
    <button class="back-btn" onclick="showWidget()">‚Üê Back</button>
    
    <div class="detail-header">
      <h2 id="detail-client-name">Client Name</h2>
      <div class="date" id="detail-session-date">Session Date</div>
    </div>
    
    <div class="section">
      <div class="section-header">Session Info</div>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Project Status</div>
          <div class="info-value" id="detail-project-status" onclick="editProjectStatus()">Status</div>
        </div>
        <div class="info-card">
          <div class="info-label">Phase</div>
          <div class="info-value" id="detail-phase" onclick="showPhaseSelector()">Phase</div>
        </div>
        <div class="info-card half-width">
          <div class="info-label">Payment</div>
          <div class="info-value" id="detail-payment" onclick="editPayment()">Status</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">Session Date</div>
          <div class="info-value" id="detail-date-edit" onclick="editDate()">Date</div>
        </div>
      </div>
    </div>
    
    
    <div id="discovery-call-container" style="display: none; margin-bottom: 12px;">
      <button class="btn-add" style="width: 100%;" onclick="scheduleDiscoveryCall()">
        üìûSchedule Discovery Callüìû
      </button>
    </div>
    <button class="btn-add toggle-btn" style="width: 100%; margin-bottom: 12px;" onclick="toggleSection('client-profile')">
      <span>üìùClient Profileüìù</span>
      <span class="toggle-icon" id="client-profile-toggle">‚¨áÔ∏è</span>
    </button>
    
    <div id="client-profile-section" class="collapsible-content">
      <div class="section">
        <div class="section-header">Client Profile</div>
        <div class="info-grid">
        <div class="info-card full-width">
          <div class="info-label">Email</div>
          <div class="info-value" id="detail-email" onclick="editTextField('Email', 'email', '1211746957812346')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Phone</div>
          <div class="info-value" id="detail-phone" onclick="editTextField('Phone', 'phone', '1211746958112303')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Instagram</div>
          <div class="info-value" id="detail-instagram" onclick="editTextField('Instagram', 'instagram', '1211746957812348')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Age</div>
          <div class="info-value" id="detail-age" onclick="editNumberField('Age', 'age', '1211746957812352')">-</div>
        </div>
        <div class="info-card" id="detail-parent-card" style="display: none;">
          <div class="info-label">Parent/Guardian</div>
          <div class="info-value" id="detail-parent" onclick="editTextField('Parent/Guardian', 'parent', '1211746957812350')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Client Type</div>
          <div class="info-value" id="detail-client-type">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Session Type</div>
<div class="info-value" id="detail-sessionType" onclick="editEnumField('Session Type', 'sessionType', '1211746958112263')">-</div>        </div>
        <div class="info-card full-width">
          <div class="info-label">Concept Style</div>
<div class="info-value" id="detail-conceptStyle" onclick="editEnumField('Concept Style', 'conceptStyle', '1211747518670337')">-</div>        </div>
        <div class="info-card">
          <div class="info-label">Creative Level</div>
          <div class="info-value" id="detail-creativeLevel" onclick="editNumberField('Creative Level (1-10)', 'creativeLevel', '1211746958112275')">-</div>
        </div>
        </div>
      </div>
    </div>
    
    <button class="btn-add toggle-btn" style="width: 100%; margin-bottom: 20px;" onclick="toggleInquiryNotes()">
      <span>üìùInquiry Notes</span>
      <span class="toggle-icon" id="inquiry-toggle">‚¨áÔ∏è</span>
    </button>
    
    <div id="inquiry-section" class="collapsible-content">
      <!-- Inquiry content will be here -->
      <div class="section">
        <div class="section-header">Inquiry Details</div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-label">Preferred Date</div>
            <div class="info-value" id="inquiry-preferredDate" onclick="editTextField('Preferred Date', 'preferredDate', '1211746957812354')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Preferred City</div>
            <div class="info-value" id="inquiry-city" onclick="editEnumField('City', 'city', '1211746957812356', [{gid:'1211746957812357',name:'Charleston'},{gid:'1211746957812358',name:'NYC'}])">-</div>
          </div>
          <div class="info-card full-width">
            <div class="info-label">Session Location</div>
            <div class="info-value" id="inquiry-sessionLocation" onclick="editTextField('Session Location', 'sessionLocation', '1211746958112261')">-</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">Creative Direction</div>
        <div class="info-grid">
          <div class="info-card full-width">
            <div class="info-label">Vision</div>
            <div class="info-value" id="inquiry-vision" onclick="editLongTextField('Vision', 'vision', '1211746958112273')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Spicy Level (1-10)</div>
            <div class="info-value" id="inquiry-spicyLevel" onclick="editNumberField('Spicy Level (1-10)', 'spicyLevel', '1211746958112277')">-</div>
          </div>
          <div class="info-card full-width">
            <div class="info-label">Must Have Photos</div>
            <div class="info-value" id="inquiry-mustHave" onclick="editTextField('Must Have Photos', 'mustHave', '1211746958112279')">-</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">Preferences</div>
        <div class="info-grid">
          <div class="info-card full-width">
            <div class="info-label">Location Preference</div>
            <div class="info-value" id="inquiry-locationPref" onclick="editTextField('Location Preference', 'locationPref', '1211746958112281')">-</div>
          </div>
          <div class="info-card full-width">
            <div class="info-label">Lighting Preference</div>
            <div class="info-value" id="inquiry-lightingPref" onclick="editTextField('Lighting Preference', 'lightingPref', '1211746958112283')">-</div>
          </div>
          <div class="info-card full-width">
            <div class="info-label">How Want to Feel</div>
            <div class="info-value" id="inquiry-howFeel" onclick="editTextField('How Want to Feel', 'howFeel', '1211746958112285')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Confidence Level (1-10)</div>
            <div class="info-value" id="inquiry-confidence" onclick="editNumberField('Confidence Level (1-10)', 'confidence', '1211746958112287')">-</div>
          </div>
          <div class="info-card full-width">
            <div class="info-label">Other Expectations</div>
            <div class="info-value" id="inquiry-expectations" onclick="editTextField('Other Expectations', 'expectations', '1211746958112289')">-</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">Financial</div>
        <div class="info-grid">
          <div class="info-card">
            <div class="info-label">Budget</div>
            <div class="info-value" id="inquiry-budget" onclick="editTextField('Budget', 'budget', '1211746958112305')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Package Interest</div>
            <div class="info-value" id="inquiry-package" onclick="editTextField('Package Interest', 'package', '1211746958112293')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Print Interest</div>
            <div class="info-value" id="inquiry-prints" onclick="editTextField('Print Interest', 'prints', '1211746958112295')">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Video Interest</div>
            <div class="info-value" id="inquiry-video" onclick="editTextField('Video Interest', 'video', '1211746958112299')">-</div>
          </div>
        </div>
      </div>
    </div>
    
    <button class="btn-add toggle-btn" style="width: 100%; margin-bottom: 12px;" onclick="toggleSection('todo')">
      <span>‚òëÔ∏èTo-Do‚òëÔ∏è</span>
      <span class="toggle-icon" id="todo-toggle">‚¨áÔ∏è</span>
    </button>
    
<div id="todo-section" class="collapsible-content">
  <div class="section">
    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
      <span>‚òëÔ∏èTo-Do‚òëÔ∏è</span>
      <button onclick="showAddSubtask()" style="background: var(--gold); color: #000; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer;">+</button>
    </div>
    <div id="add-subtask-container" style="display: none; margin-bottom: 16px;">
      <input type="text" id="subtask-name-input" class="form-input" placeholder="Enter sub-task name..." style="width: 100%; margin-bottom: 8px;">
      <div style="display: flex; gap: 8px;">
        <button onclick="createNewSubtask()" class="btn-add" style="flex: 1;">Create</button>
        <button onclick="cancelAddSubtask()" class="btn-add" style="flex: 1; background: transparent; border: 1px solid var(--border);">Cancel</button>
      </div>
    </div>
    <div id="detail-todos"></div>
  </div>
</div>
    
    <button class="btn-add toggle-btn" style="width: 100%; margin-bottom: 12px;" onclick="toggleSection('completed')">
      <span>‚úÖCompleted‚úÖ</span>
      <span class="toggle-icon" id="completed-toggle">‚¨áÔ∏è</span>
    </button>
    
    <div id="completed-section" class="collapsible-content">
      <div class="section">
        <div class="section-header">Completed</div>
        <div id="detail-completed"></div>
      </div>
    </div>
  </div>
  
  <!-- Inquiry Notes View -->
  <div id="inquiry-view" class="view">
    <button class="back-btn" onclick="backToDetail()">‚Üê Back to Client</button>
    
    <div class="detail-header">
      <h2>üìùInquiry Notesüìù</h2>
      <div class="date" id="inquiry-client-name">Client Name</div>
    </div>
    
    <div class="section">
      <div class="section-header">Inquiry Details</div>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Preferred Date</div>
          <div class="info-value" id="inquiry-preferredDate" onclick="editTextField('Preferred Date', 'preferredDate', '1211746957812354')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Preferred City</div>
          <div class="info-value" id="inquiry-city" onclick="editEnumField('City', 'city', '1211746957812356', [{gid:'1211746957812357',name:'Charleston'},{gid:'1211746957812358',name:'NYC'}])">-</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">Session Location</div>
          <div class="info-value" id="inquiry-sessionLocation" onclick="editTextField('Session Location', 'sessionLocation', '1211746958112261')">-</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">Creative Direction</div>
      <div class="info-grid">
        <div class="info-card full-width">
          <div class="info-label">Vision</div>
          <div class="info-value" id="inquiry-vision" onclick="editLongTextField('Vision', 'vision', '1211746958112273')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Spicy Level (1-10)</div>
          <div class="info-value" id="inquiry-spicyLevel" onclick="editNumberField('Spicy Level (1-10)', 'spicyLevel', '1211746958112277')">-</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">Must Have Photos</div>
          <div class="info-value" id="inquiry-mustHave" onclick="editTextField('Must Have Photos', 'mustHave', '1211746958112279')">-</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">Preferences</div>
      <div class="info-grid">
        <div class="info-card full-width">
          <div class="info-label">Location Preference</div>
          <div class="info-value" id="inquiry-locationPref" onclick="editTextField('Location Preference', 'locationPref', '1211746958112281')">-</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">Lighting Preference</div>
          <div class="info-value" id="inquiry-lightingPref" onclick="editTextField('Lighting Preference', 'lightingPref', '1211746958112283')">-</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">How Want to Feel</div>
          <div class="info-value" id="inquiry-howFeel" onclick="editTextField('How Want to Feel', 'howFeel', '1211746958112285')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Confidence Level (1-10)</div>
          <div class="info-value" id="inquiry-confidence" onclick="editNumberField('Confidence Level (1-10)', 'confidence', '1211746958112287')">-</div>
        </div>
        <div class="info-card full-width">
          <div class="info-label">Other Expectations</div>
          <div class="info-value" id="inquiry-expectations" onclick="editTextField('Other Expectations', 'expectations', '1211746958112289')">-</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">Financial</div>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Budget</div>
          <div class="info-value" id="inquiry-budget" onclick="editTextField('Budget', 'budget', '1211746958112305')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Package Selected</div>
          <div class="info-value" id="inquiry-package" onclick="editTextField('Package Selected', 'package', '1211746958112293')">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Interested in Prints</div>
          <div class="info-value" id="inquiry-prints" onclick="editEnumField('Interested in Prints', 'prints', '1211746958112295', [{gid:'1211746958112296',name:'yes'},{gid:'1211746958112297',name:'no'}])">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Interested in Video</div>
          <div class="info-value" id="inquiry-video" onclick="editEnumField('Interested in Video', 'video', '1211746958112299', [{gid:'1211746958112300',name:'yes'},{gid:'1211746958112301',name:'no'}])">-</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Phase Selector View -->
  <div id="phase-view" class="view">
    <button class="back-btn" onclick="backToDetail()">‚Üê Back</button>
    
    <div class="detail-header">
      <h2>Select Phase</h2>
      <div class="date" id="phase-client-name">Client Name</div>
    </div>
    
    <div id="phase-list"></div>
  </div>
  
  <!-- Add Client Modal -->
<div id="add-client-modal" class="modal" onclick="if(event.target === this) closeAddClient()">
  <div class="modal-content">
      <div class="modal-header">Add New Client</div>
      <div class="form-group">
        <label class="form-label">Client Name</label>
        <input type="text" id="client-name" class="form-input" placeholder="Enter client name">
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="closeAddClient()">Cancel</button>
        <button class="btn btn-primary" onclick="createClient()">Create</button>
      </div>
    </div>
  </div>
  
  <!-- Token Modal -->
  <div id="token-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Asana Token Required</div>
      <div class="form-group">
        <label class="form-label">Personal Access Token</label>
        <input type="password" id="token-input" class="form-input" placeholder="Enter your Asana token">
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="saveToken()">Save Token</button>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  
  <script>
    // Configuration - Field IDs
    const PROJECT_ID = '1211733193402684';
    const CLIENT_PHASE_FIELD_ID = '1211735634914711';
    const SESSION_DATE_FIELD_ID = '1211732464258476';
    const ACTIVE_STATUS_FIELD_ID = '1211735138096716';
    const CLIENT_TYPE_FIELD_ID = '1211733359641772'; // Changed from SESSION_TYPE
    const PAYMENT_STATUS_FIELD_ID = '1211733390060955';
    
    // All custom field IDs
    const FIELD_IDS = {
      email: '1211746957812346',
      phone: '1211746958112303',
      instagram: '1211746957812348',
      parent: '1211746957812350',
      age: '1211746957812352',
      sessionType: '1211746958112263',
      conceptStyle: '1211747518670337',
      creativeLevel: '1211746958112275',
      preferredDate: '1211746957812354',
      city: '1211746957812356',
      sessionLocation: '1211746958112261',
      vision: '1211746958112273',
      spicyLevel: '1211746958112277',
      mustHave: '1211746958112279',
      locationPref: '1211746958112281',
      lightingPref: '1211746958112283',
      howFeel: '1211746958112285',
      confidence: '1211746958112287',
      expectations: '1211746958112289',
      budget: '1211746958112305',
      package: '1211746958112293',
      prints: '1211746958112295',
      video: '1211746958112299'
    };
    // Enum field options
    const ENUM_OPTIONS = {
      '1211747518670337': [ // Concept Style
        {gid: '1211747518670340', name: 'Anything really, I give you full creative control'},
        {gid: '1211747518670341', name: 'Goddess [healing, empowering, flowy, usually at the beach]'},
        {gid: '1211747518670342', name: 'Swim - Vintage Glam Editorials'},
        {gid: '1211747518670343', name: 'The Celestials [Mystical angel theme]'},
        {gid: '1211747518670344', name: 'Wanderlust [nostalgic, cinematic, warm, naturey]'},
        {gid: '1211747518670345', name: 'Dreamland [editorial, surreal & dreamy, usually with use of props]'},
        {gid: '1211747518670346', name: 'Siren [Underwater]'},
        {gid: '1211747518670347', name: 'Lethal Woman Energy [night-out fashion, in-your-face]'},
        {gid: '1211747518670348', name: 'Lofi [low light, grainy, rich colors]'},
        {gid: '1211747518670349', name: 'Fairycore [fairy fashion]'},
        {gid: '1211747518670350', name: 'Earth Angels [editorial angel theme]'},
        {gid: '1211747518670351', name: 'Street [LA/NYC street fashion]'},
        {gid: '1211747518670352', name: 'Neo Punk [Futuristic]'}
      ]
      ,
      '1211746958112263': [ // Session Type
        {gid: '1211746958112264', name: 'A Personal Photoshoot'},
        {gid: '1211746958112265', name: 'Model Test Shoot'},
        {gid: '1211746958112266', name: 'Vintage Glam Swimwear Session'},
        {gid: '1211746958112267', name: 'Commercial Photos for my business or brand'},
        {gid: '1211746958112268', name: 'Senior Photos'},
        {gid: '1211746958112269', name: 'Maternity'},
        {gid: '1211746958112270', name: 'Headshots'},
        {gid: '1211746958112271', name: "Couple's Session"}
      ]
    };
    // State
    let asanaToken = localStorage.getItem('asana_token') || '';
    let sessions = [];
    let phaseOptions = [];
    let currentSession = null;
    let currentFilters = {
      phase: '',
      type: ''
    };
    
    // Proxy helper
    function proxyUrl(asanaPath) {
      return `https://d.rook-bb4.workers.dev?path=${encodeURIComponent(asanaPath)}`;
    }
    
    // API Functions
    async function fetchSessions() {
      const response = await fetch(
        proxyUrl(`/tasks?project=${PROJECT_ID}&opt_fields=name,custom_fields,gid`),
        {
          headers: { 'Authorization': `Bearer ${asanaToken}` }
        }
      );
      const data = await response.json();
      
      return data.data
        .filter(task => {
          const activeStatus = task.custom_fields.find(f => f.gid === ACTIVE_STATUS_FIELD_ID);
          return !activeStatus || activeStatus.enum_value?.name !== '√∞≈∏‚Äù¬¥';
        })
        .map(task => {
          const getField = (id) => task.custom_fields.find(f => f.gid === id);
          
          const phaseField = getField(CLIENT_PHASE_FIELD_ID);
          const sessionDateField = getField(SESSION_DATE_FIELD_ID);
          const clientTypeField = getField(CLIENT_TYPE_FIELD_ID);
          const paymentField = getField(PAYMENT_STATUS_FIELD_ID);
          
          // Handle both Asana date formats: date_value.date OR date_value (string)
          const sessionDate = sessionDateField?.date_value?.date || sessionDateField?.date_value || null;
          const daysUntil = sessionDate ? Math.ceil((new Date(sessionDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
          
          return {
            gid: task.gid,
            client: task.name,
            status: phaseField?.enum_value?.name || 'No Phase',
            statusGid: phaseField?.enum_value?.gid || '',
            sessionDate: sessionDate,
            clientType: clientTypeField?.multi_enum_values?.[0]?.name || 'Client',
            paymentStatus: paymentField?.enum_value?.name || 'Unpaid',
            countdown: getCountdown(daysUntil),
            // Profile fields
            email: getField(FIELD_IDS.email)?.text_value || '',
            phone: getField(FIELD_IDS.phone)?.text_value || '',
            instagram: getField(FIELD_IDS.instagram)?.text_value || '',
            parent: getField(FIELD_IDS.parent)?.text_value || '',
            age: getField(FIELD_IDS.age)?.number_value || null,
            sessionType: getField(FIELD_IDS.sessionType)?.enum_value?.name || '',
            conceptStyle: getField(FIELD_IDS.conceptStyle)?.multi_enum_values?.map(v => v.name).join(', ') || '',
            creativeLevel: getField(FIELD_IDS.creativeLevel)?.number_value || null,
            // Inquiry fields
            preferredDate: getField(FIELD_IDS.preferredDate)?.text_value || '',
            city: getField(FIELD_IDS.city)?.enum_value?.name || '',
            sessionLocation: getField(FIELD_IDS.sessionLocation)?.text_value || '',
            vision: getField(FIELD_IDS.vision)?.text_value || '',
            spicyLevel: getField(FIELD_IDS.spicyLevel)?.number_value || null,
            mustHave: getField(FIELD_IDS.mustHave)?.text_value || '',
            locationPref: getField(FIELD_IDS.locationPref)?.text_value || '',
            lightingPref: getField(FIELD_IDS.lightingPref)?.text_value || '',
            howFeel: getField(FIELD_IDS.howFeel)?.text_value || '',
            confidence: getField(FIELD_IDS.confidence)?.number_value || null,
            expectations: getField(FIELD_IDS.expectations)?.text_value || '',
            budget: getField(FIELD_IDS.budget)?.text_value || '',
            package: getField(FIELD_IDS.package)?.text_value || '',
            prints: getField(FIELD_IDS.prints)?.enum_value?.name || '',
            video: getField(FIELD_IDS.video)?.enum_value?.name || ''
          };
        })
        .sort((a, b) => {
          if (!a.sessionDate) return 1;
          if (!b.sessionDate) return -1;
          return new Date(a.sessionDate) - new Date(b.sessionDate);
        });
    }
    
    function getCountdown(days) {
      if (days === null) return { text: 'No date', color: 'var(--text-secondary)', bg: 'transparent' };
      if (days < 0) return { text: `${Math.abs(days)}d ago`, color: 'var(--text-secondary)', bg: 'transparent' };
      if (days === 0) return { text: 'TODAY', color: '#fff', bg: 'var(--critical)' };
      if (days <= 3) return { text: `${days}d`, color: '#fff', bg: 'var(--critical)' };
      if (days <= 14) return { text: `${days}d`, color: '#000', bg: 'var(--limited)' };
      return { text: `${days}d`, color: '#000', bg: 'var(--available)' };
    }
    
    async function fetchPhaseOptions() {
      const response = await fetch(
        proxyUrl(`/custom_fields/${CLIENT_PHASE_FIELD_ID}`),
        {
          headers: { 'Authorization': `Bearer ${asanaToken}` }
        }
      );
      const data = await response.json();
      phaseOptions = data.data.enum_options || [];
    }
    
    async function fetchTodos(parentGid) {
      const response = await fetch(
        proxyUrl(`/tasks/${parentGid}/subtasks?opt_fields=name,completed,gid`),
        {
          headers: { 'Authorization': `Bearer ${asanaToken}` }
        }
      );
      const data = await response.json();
      return data.data || [];
    }
    
    async function completeTask(todoGid) {
      await fetch(proxyUrl(`/tasks/${todoGid}`), {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${asanaToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ data: { completed: true } })
      });
    }
    
    async function updateTaskPhase(taskGid, phaseGid) {
      await fetch(proxyUrl(`/tasks/${taskGid}`), {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${asanaToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          data: {
            custom_fields: {
              [CLIENT_PHASE_FIELD_ID]: phaseGid
            }
          }
        })
      });
    }
    
    async function updateTaskCustomField(taskGid, fieldGid, value) {
      const data = {
        data: {
          custom_fields: {
            [fieldGid]: value
          }
        }
      };
      
      console.log('Updating Asana field:', {
        taskGid,
        fieldGid,
        value,
        requestBody: JSON.stringify(data, null, 2)
      });
      
      try {
        const response = await fetch(proxyUrl(`/tasks/${taskGid}`), {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${asanaToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Asana API Error:', response.status, errorText);
          let errorObj;
          try {
            errorObj = JSON.parse(errorText);
            console.error('Parsed error:', JSON.stringify(errorObj, null, 2));
          } catch (e) {
            console.error('Raw error:', errorText);
          }
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('Update successful:', result);
        return result;
      } catch (error) {
        console.error('Update failed:', error);
        showToast('Error: ' + error.message);
        throw error;
      }
    }
    
    async function createNewClient(name) {
      const response = await fetch(proxyUrl('/tasks'), {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${asanaToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          data: {
            name: name,
            projects: [PROJECT_ID]
          }
        })
      });
      return await response.json();
    }
    
    // View Functions
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }
    
    function showWidget() {
      showView('widget-view');
    }
    
    
    
    function showDetail(gid) {
      currentSession = sessions.find(s => s.gid === gid);
      if (currentSession) {
        showView('detail-view');
        renderClientDetail();
      }
    }
    
    function showPhaseSelector() {
      showView('phase-view');
      renderPhaseSelector();
    }
    
    
    
    
    
    function backToDetail() {
      showView('detail-view');
      renderClientDetail();
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    
    function showTokenModal() {
      document.getElementById('token-modal').classList.add('active');
      document.getElementById('token-input').focus();
    }
    
    function saveToken() {
      const token = document.getElementById('token-input').value.trim();
      if (token) {
        asanaToken = token;
        localStorage.setItem('asana_token', token);
        document.getElementById('token-modal').classList.remove('active');
        init();
      }
    }
    
    function closeAddClient() {
      document.getElementById('add-client-modal').classList.remove('active');
      document.getElementById('client-name').value = '';
    }
    
    async function createClient() {
      const name = document.getElementById('client-name').value.trim();
      if (!name) return;
      
      await createNewClient(name);
      closeAddClient();
      showToast('Client created');
      await renderWidget();
    }
    
    function applyFilters() {
      currentFilters.phase = document.getElementById('widget-filter-phase').value;
      currentFilters.type = document.getElementById('widget-filter-type').value;
      
      const container = document.getElementById('widget-sessions');
      const filteredSessions = getFilteredSessions();
      
      if (filteredSessions.length === 0) {
        container.innerHTML = '<div class="loading"><div>No sessions match filters</div></div>';
        return;
      }
      
      container.innerHTML = filteredSessions.map(session => `
        <div class="card" onclick="showDetail('${session.gid}')">
          <div class="card-header">
            <div class="card-client">${session.client}</div>
            <div class="card-countdown" style="background: ${session.countdown.bg}; color: ${session.countdown.color};">
              ${session.countdown.text}
            </div>
          </div>
          <div class="card-info">${session.clientType} | ${session.status}</div>
          <div class="card-date">${formatDate(session.sessionDate)}</div>
        </div>
      `).join('');
    }
    
    function getFilteredSessions() {
      return sessions.filter(session => {
        const phaseMatch = !currentFilters.phase || session.status === currentFilters.phase;
        const typeMatch = !currentFilters.type || session.clientType === currentFilters.type;
        return phaseMatch && typeMatch;
      });
    }
    
    // Edit Functions
    function editTextField(label, field, fieldId) {
      if (!currentSession) return;
      const currentValue = currentSession[field] || '';
      const inputHTML = `<input type="text" id="edit-input" class="form-input" style="width: 100%; margin: 8px 0;" value="${currentValue}" placeholder="Enter ${label}"><button onclick="saveTextField('${field}', '${fieldId}')" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>`;
      
      // Check which element exists (detail vs inquiry)
      const detailEl = document.getElementById(`detail-${field}`);
      const inquiryEl = document.getElementById(`inquiry-${field}`);
      const targetEl = detailEl || inquiryEl;
      
      if (!targetEl) {
        console.error(`Neither detail-${field} nor inquiry-${field} element found`);
        return;
      }
      
      targetEl.innerHTML = inputHTML;
      document.getElementById('edit-input').focus();
    }
    
    function editLongTextField(label, field, fieldId) {
      if (!currentSession) return;
      const currentValue = currentSession[field] || '';
      const inputHTML = `<textarea id="edit-input" class="form-textarea" style="width: 100%; margin: 8px 0;" placeholder="Enter ${label}">${currentValue}</textarea><button onclick="saveTextField('${field}', '${fieldId}')" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>`;
      document.getElementById(`inquiry-${field}`).innerHTML = inputHTML;
      document.getElementById('edit-input').focus();
    }
    
    function editNumberField(label, field, fieldId) {
      if (!currentSession) return;
      const currentValue = currentSession[field] || '';
      const inputHTML = `<input type="number" id="edit-input" class="form-input" style="width: 100%; margin: 8px 0;" value="${currentValue}" placeholder="Enter ${label}"><button onclick="saveNumberField('${field}', '${fieldId}')" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>`;
      
      // Check which element exists (detail vs inquiry)
      const detailEl = document.getElementById(`detail-${field}`);
      const inquiryEl = document.getElementById(`inquiry-${field}`);
      const targetEl = detailEl || inquiryEl;
      
      if (!targetEl) {
        console.error(`Neither detail-${field} nor inquiry-${field} element found`);
        return;
      }
      
      targetEl.innerHTML = inputHTML;
      document.getElementById('edit-input').focus();
    }
    
   function editEnumField(label, field, fieldId, options) {
      if (!currentSession) return;
      const currentValue = currentSession[field] || '';
      
      // Fallback to ENUM_OPTIONS if options not provided
      const opts = options || ENUM_OPTIONS[fieldId] || [];
      
const selectHTML = '<select id="edit-select" class="filter-select" style="width: 100%; margin: 8px 0;" onclick="event.stopPropagation()">' +        `<option value="">Select ${label}</option>` +
        opts.map(opt => `<option value="${opt.gid}" ${opt.name === currentValue ? 'selected' : ''}>${opt.name}</option>`).join('') +
        `</select><button onclick="saveEnumField('${field}', '${fieldId}')" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>`;
      const targetEl = document.getElementById(`detail-${field}`) || document.getElementById(`inquiry-${field}`);
      if (targetEl) targetEl.innerHTML = selectHTML;
    }
    
    async function saveTextField(field, fieldId) {
      const value = document.getElementById('edit-input').value;
      await updateTaskCustomField(currentSession.gid, fieldId, value);
      currentSession[field] = value;
      showToast('Updated');
      
      // Check which element exists (detail vs inquiry)
      const detailEl = document.getElementById(`detail-${field}`);
      const inquiryEl = document.getElementById(`inquiry-${field}`);
      const targetEl = detailEl || inquiryEl;
      
      if (targetEl) {
        targetEl.textContent = value || '-';
      }
    }
    
    async function saveNumberField(field, fieldId) {
      const value = parseFloat(document.getElementById('edit-input').value) || null;
      await updateTaskCustomField(currentSession.gid, fieldId, value);
      currentSession[field] = value;
      showToast('Updated');
      
      // Check which element exists (detail vs inquiry)
      const detailEl = document.getElementById(`detail-${field}`);
      const inquiryEl = document.getElementById(`inquiry-${field}`);
      const targetEl = detailEl || inquiryEl;
      
      if (targetEl) {
        targetEl.textContent = value || '-';
      }
      
      // Special handling for age - show/hide parent field
      if (field === 'age') {
        const parentCard = document.getElementById('detail-parent-card');
        if (value && value < 18) {
          parentCard.style.display = 'block';
        } else {
          parentCard.style.display = 'none';
        }
      }
    }
    
    async function saveEnumField(field, fieldId) {
      const select = document.getElementById('edit-select');
      const gid = select.value;
      const name = select.options[select.selectedIndex].text;
      
      await updateTaskCustomField(currentSession.gid, fieldId, gid);
      currentSession[field] = name;
      showToast('Updated');
const targetEl = document.getElementById(`detail-${field}`) || document.getElementById(`inquiry-${field}`);
if (targetEl) targetEl.textContent = name || '-';    
    }
    
    function editPayment() {
      if (!currentSession) return;
      const options = [
        { gid: '1211733390060958', name: 'Unpaid' },
        { gid: '1211733390060959', name: 'Partial' },
        { gid: '1211733390060960', name: 'Paid' }
      ];
      const currentValue = document.getElementById('detail-payment').textContent;
      const selectHTML = '<select id="payment-select" class="filter-select" style="width: 100%; margin: 8px 0;">' +
        options.map(opt => `<option value="${opt.gid}" ${opt.name === currentValue ? 'selected' : ''}>${opt.name}</option>`).join('') +
        '</select><button onclick="savePayment()" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>';
      document.getElementById('detail-payment').innerHTML = selectHTML;
    }
    
    async function savePayment() {
      const gid = document.getElementById('payment-select').value;
      const select = document.getElementById('payment-select');
      const name = select.options[select.selectedIndex].text;
      await updateTaskCustomField(currentSession.gid, '1211733390060955', gid);
      currentSession.paymentStatus = name;
      showToast('Payment updated');
      document.getElementById('detail-payment').textContent = name;
    }
    
    function editProjectStatus() {
      if (!currentSession) return;
      const options = [
        { gid: '1211735138096719', name: 'üî¥ - Not Booked' },
        { gid: '1211735138096720', name: 'üü¢ - Booked' },
        { gid: '1211776526581111', name: '‚ö†Ô∏è - Reschedule' },
        { gid: '1211776526581112', name: '‚úÖ - Session Complete' }
      ];
      const currentValue = document.getElementById('detail-project-status').textContent;
      const selectHTML = '<select id="project-status-select" class="filter-select" style="width: 100%; margin: 8px 0;">' +
        options.map(opt => `<option value="${opt.gid}" ${opt.name === currentValue ? 'selected' : ''}>${opt.name}</option>`).join('') +
        '</select><button onclick="saveProjectStatus()" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>';
      document.getElementById('detail-project-status').innerHTML = selectHTML;
    }
    
    async function saveProjectStatus() {
      const gid = document.getElementById('project-status-select').value;
      const select = document.getElementById('project-status-select');
      const name = select.options[select.selectedIndex].text;
      await updateTaskCustomField(currentSession.gid, '1211735138096716', gid);
      currentSession.projectStatus = name;
      showToast('Project Status updated');
      document.getElementById('detail-project-status').textContent = name;
    }
    
    function editDate(event) {
      if (event) event.stopPropagation();
      if (!currentSession) return;
      const currentDate = currentSession.sessionDate || '';
      const container = document.getElementById('detail-date-edit');
      container.onclick = null; // Remove onclick to prevent conflicts
      const inputHTML = '<input type="date" id="date-input" class="form-input" style="width: 100%; margin: 8px 0;" value="' + currentDate + '" onclick="event.stopPropagation()"><button onclick="saveDate()" class="btn-add" style="width: 100%; margin-top: 8px;">Save</button>';
      container.innerHTML = inputHTML;
      setTimeout(() => document.getElementById('date-input').focus(), 100);
    }
    
    async function saveDate() {
      const newDate = document.getElementById('date-input').value;
      // Asana expects date fields in object format: {"date": "YYYY-MM-DD"}
      await updateTaskCustomField(currentSession.gid, '1211732464258476', newDate ? { date: newDate } : null);
      currentSession.sessionDate = newDate;
      showToast('Date updated');
      const container = document.getElementById('detail-date-edit');
      container.textContent = formatDate(newDate);
      container.onclick = editDate; // Restore onclick
      document.getElementById('detail-session-date').textContent = formatDate(newDate);
    }

    async function scheduleDiscoveryCall() {
      if (!currentSession) return;
      const currentDate = '';
      const container = document.createElement('div');
      container.innerHTML = `
        <div style="padding: 20px; background: var(--bg-card); border-radius: 8px; margin-bottom: 12px;">
          <h3 style="color: var(--gold); margin-bottom: 12px;">Schedule Discovery Call</h3>
          <input type="datetime-local" id="discovery-date-input" class="form-input" style="width: 100%; margin-bottom: 12px;" value="${currentDate}">
          <div style="margin-top: 12px;">
  <label style="color: var(--gold); display: block; margin-bottom: 6px;">Duration</label>
  <select id="discovery-duration-hours" style="width: 80px; margin-right: 8px;">
    <option>0</option>
    <option selected>1</option>
    <option>2</option>
    <option>3</option>
  </select> hrs
  <select id="discovery-duration-minutes" style="width: 80px; margin-left: 12px;">
    <option selected>0</option>
    <option>15</option>
    <option>30</option>
    <option>45</option>
  </select> min
</div>
          <button onclick="saveDiscoveryCall()" class="btn-add" style="width: 100%; margin-bottom: 8px;">Save & Add to Calendar</button>
          <button onclick="closeDiscoveryCallModal()" class="btn-add" style="width: 100%; background: transparent; border: 1px solid var(--border);">Cancel</button>
          <p style="color: var(--text-secondary); font-size: 12px; margin-top: 12px;">Note: Calendar integration via Zapier (auto-syncs to Google Calendar)</p>
        </div>
      `;
      const discoveryContainer = document.getElementById('discovery-call-container');
      discoveryContainer.insertAdjacentElement('afterend', container);
      container.id = 'discovery-modal-temp';
    }
    
    async function saveDiscoveryCall() {
const dateInput = document.getElementById('discovery-date-input').value;
      const hours = document.getElementById('discovery-duration-hours').value;
const minutes = document.getElementById('discovery-duration-minutes').value;
const duration = `${hours}h ${minutes}m`;
      const timeOnly = dateInput.split('T')[1];
const [hrs, mins] = timeOnly.split(':');
const hour12 = hrs % 12 || 12;
const ampm = hrs >= 12 ? 'PM' : 'AM';
const formattedTime = `${hour12}:${mins} ${ampm}`;
      if (!dateInput) {
        showToast('Please select a date and time');
        return;
      }
      
      // Convert datetime-local format (YYYY-MM-DDTHH:MM) to just date (YYYY-MM-DD)
      // Asana date fields only accept YYYY-MM-DD format
const dateOnly = dateInput.split('T')[0];
      console.log('Discovery Call - Converting datetime:', {
        originalInput: dateInput,
        convertedDate: dateOnly
      });
      
      // Update Discovery Call Date custom field in Asana
      // Field ID: 1211733488948188 (from your IDs doc)
      try {
const isoDateTime = new Date(dateInput).toISOString();
await updateTaskCustomField(currentSession.gid, '1211733488948188', {date_time: isoDateTime});
        await updateTaskCustomField(currentSession.gid, '1211748802050313', duration);
await updateTaskCustomField(currentSession.gid, '1211748802050319', formattedTime);
        showToast('Discovery call scheduled! Calendar sync via Zapier.');
        closeDiscoveryCallModal();
        setTimeout(renderClientDetail, 300);
      } catch (error) {
        console.error('Failed to save discovery call:', error);
      }
    }
    
    function closeDiscoveryCallModal() {
      const modal = document.getElementById('discovery-modal-temp');
      if (modal) modal.remove();
    }

    
    async function uncompleteTodo(todoGid) {
      await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${todoGid}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${asanaToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ data: { completed: false } })
      });
      showToast('Task uncompleted');
      setTimeout(renderClientDetail, 300);
    }
    
    // Render Functions
    async function renderWidget() {
      const container = document.getElementById('widget-sessions');
      container.innerHTML = '<div class="loading"><div>Loading sessions...</div></div>';
      
      try {
        sessions = await fetchSessions();
        await fetchPhaseOptions();
        
        
        if (sessions.length === 0) {
          container.innerHTML = '<div class="loading"><div>No sessions</div></div>';
          return;
        }
        
        const filteredSessions = getFilteredSessions();
        container.innerHTML = filteredSessions.map(session => `
          <div class="card" onclick="showDetail('${session.gid}')">
            <div class="card-header">
              <div class="card-client">${session.client}</div>
              <div class="card-countdown" style="background: ${session.countdown.bg}; color: ${session.countdown.color};">
                ${session.countdown.text}
              </div>
            </div>
            <div class="card-info">${session.clientType} | ${session.status}</div>
            <div class="card-date">${formatDate(session.sessionDate)}</div>
          </div>
        `).join('');
        
        populateFilters();
      } catch (error) {
        container.innerHTML = '<div class="loading"><div>Error loading sessions</div></div>';
        console.error('Error:', error);
      }
    }
    
    function populateFilters() {
      const phaseSelect = document.getElementById('widget-filter-phase');
      const uniquePhases = [...new Set(sessions.map(s => s.status))];
      phaseSelect.innerHTML = '<option value="">All Phases</option>' + 
        uniquePhases.map(phase => `<option value="${phase}">${phase}</option>`).join('');
      
      const typeSelect = document.getElementById('widget-filter-type');
      const uniqueTypes = [...new Set(sessions.map(s => s.clientType))];
      typeSelect.innerHTML = '<option value="">All Types</option>' + 
        uniqueTypes.map(type => `<option value="${type}">${type}</option>`).join('');
    }
    
    function renderClientList() {
      const container = document.getElementById('client-list');
      const filteredSessions = getFilteredSessions();
      
      if (filteredSessions.length === 0) {
        container.innerHTML = '<div class="loading"><div>No sessions match filters</div></div>';
        return;
      }
      
      container.innerHTML = filteredSessions.map(session => `
        <div class="list-item" onclick="showDetail('${session.gid}')">
          <div class="list-item-left">
            <h3>${session.client}</h3>
            <p>${session.clientType} | ${session.status}</p>
          </div>
          <div class="list-item-right" style="color: ${session.countdown.color}; background: ${session.countdown.bg};">
            ${session.countdown.text}
          </div>
        </div>
      `).join('');
    }
    
    async function renderClientDetail() {
      if (!currentSession) return;
      
      document.getElementById('detail-client-name').textContent = currentSession.client;
      document.getElementById('detail-session-date').textContent = formatDate(currentSession.sessionDate);
      document.getElementById('detail-project-status').textContent = currentSession.projectStatus || 'Status';
      document.getElementById('detail-phase').textContent = currentSession.status;
      document.getElementById('detail-payment').textContent = currentSession.paymentStatus;
      document.getElementById('detail-date-edit').textContent = formatDate(currentSession.sessionDate);
      
      // Show/hide Discovery Call button (only for Phase I & II)
      const discoveryContainer = document.getElementById('discovery-call-container');
      const phaseText = currentSession.status || '';
      if (phaseText.includes('Phase I') || phaseText.includes('Phase II')) {
        discoveryContainer.style.display = 'block';
      } else {
        discoveryContainer.style.display = 'none';
      }
      
      // Profile fields
      document.getElementById('detail-email').textContent = currentSession.email || '-';
      document.getElementById('detail-phone').textContent = currentSession.phone || '-';
      
      // Instagram with link
      const instaEl = document.getElementById('detail-instagram');
      if (currentSession.instagram) {
        const handle = currentSession.instagram.replace('@', '');
        instaEl.innerHTML = `<a href="https://instagram.com/${handle}" target="_blank">@${handle}</a>`;
      } else {
        instaEl.textContent = '-';
      }
      
      document.getElementById('detail-age').textContent = currentSession.age || '-';
      
      // Show/hide parent field based on age
      const parentCard = document.getElementById('detail-parent-card');
      if (currentSession.age && currentSession.age < 18) {
        parentCard.style.display = 'block';
        document.getElementById('detail-parent').textContent = currentSession.parent || '-';
      } else {
        parentCard.style.display = 'none';
      }
      
      document.getElementById('detail-client-type').textContent = currentSession.clientType || '-';
      document.getElementById('detail-sessionType').textContent = currentSession.sessionType || '-';
      document.getElementById('detail-conceptStyle').textContent = currentSession.conceptStyle || '-';
      document.getElementById('detail-creativeLevel').textContent = currentSession.creativeLevel || '-';
      
      // Todos
      const todosContainer = document.getElementById('detail-todos');
      const completedContainer = document.getElementById('detail-completed');
      todosContainer.innerHTML = '<div class="loading" style="padding: 20px;"><div>Loading...</div></div>';
      console.log('Fetching todos for:', currentSession.gid);
      completedContainer.innerHTML = '<div class="loading" style="padding: 20px;"><div>Loading...</div></div>';
      
      const allTodos = await fetchTodos(currentSession.gid);
            console.log('Todos fetched:', allTodos);
      const incompleteTodos = allTodos.filter(t => !t.completed);
      const completedTodos = allTodos.filter(t => t.completed);
      console.log('Containers:', todosContainer, completedContainer);
      console.log('Incomplete:', incompleteTodos.length, 'Completed:', completedTodos.length);
if (incompleteTodos.length === 0) {
  todosContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No to-do items</div>';
} else {
  todosContainer.innerHTML = incompleteTodos.map(todo => `
<div class="todo-item" onclick="completeTodo('${todo.gid}')">
  <span class="todo-text">[ ] ${todo.name}</span>
  <button class="hide-btn" onclick="event.stopPropagation(); archiveAndHideSubtask('${todo.gid}', '${todo.name.replace(/'/g, "\\'")}')">Hide</button>
</div>
  `).join('');
}
      
if (completedTodos.length === 0) {
  completedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No completed tasks</div>';
} else {
  completedContainer.innerHTML = completedTodos.map(todo => `
<div class="todo-item" onclick="completeTodo('${todo.gid}')">
  <span class="todo-text">[ ] ${todo.name}</span>
  <button class="hide-btn" onclick="event.stopPropagation(); archiveAndHideSubtask('${todo.gid}', '${todo.name.replace(/'/g, "\\'")}')">Hide</button>
</div>
  `).join('');
}
      
      if (completedTodos.length === 0) {
        completedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No completed tasks</div>';
      } else {
        completedContainer.innerHTML = completedTodos.map(todo => `
          <div class="todo-item completed" style="opacity: 0.6;" onclick="uncompleteTodo('${todo.gid}')">
            [√¢≈ì‚Äú] ${todo.name}
          </div>
        `).join('');
      }
    }
    
    function renderInquiryNotes() {
      if (!currentSession) return;
      
      document.getElementById('inquiry-client-name').textContent = currentSession.client;
      
      // Inquiry details
      document.getElementById('inquiry-preferred-date').textContent = currentSession.preferredDate || '-';
      document.getElementById('inquiry-city').textContent = currentSession.city || '-';
      document.getElementById('inquiry-location').textContent = currentSession.sessionLocation || '-';
      
      // Creative direction
      document.getElementById('inquiry-vision').textContent = currentSession.vision || '-';
      document.getElementById('inquiry-spicy').textContent = currentSession.spicyLevel || '-';
      document.getElementById('inquiry-must-have').textContent = currentSession.mustHave || '-';
      
      // Preferences
      document.getElementById('inquiry-locationPref').textContent = currentSession.locationPref || '-';
      document.getElementById('inquiry-lightingPref').textContent = currentSession.lightingPref || '-';
      document.getElementById('inquiry-howFeel').textContent = currentSession.howFeel || '-';
      document.getElementById('inquiry-confidence').textContent = currentSession.confidence || '-';
      document.getElementById('inquiry-expectations').textContent = currentSession.expectations || '-';
      
      // Financial
      document.getElementById('inquiry-budget').textContent = currentSession.budget || '-';
      document.getElementById('inquiry-package').textContent = currentSession.package || '-';
      document.getElementById('inquiry-prints').textContent = currentSession.prints || '-';
      document.getElementById('inquiry-video').textContent = currentSession.video || '-';
    }
    
    function renderPhaseSelector() {
      const container = document.getElementById('phase-list');
      document.getElementById('phase-client-name').textContent = currentSession?.client || 'Client';
      
      const currentPhaseGid = currentSession?.statusGid || '';
      
      container.innerHTML = phaseOptions.map(phase => {
        const isCurrent = phase.gid === currentPhaseGid;
        return `
          <div class="list-item" onclick="updatePhase('${phase.gid}', '${phase.name}')">
            <div class="list-item-left">
              <h3 style="color: ${isCurrent ? 'var(--gold)' : 'var(--text-primary)'}">
                ${isCurrent ? '[*] ' : ''}${phase.name}
              </h3>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function completeTodo(todoGid) {
      await completeTask(todoGid);
      showToast('Task completed');
      setTimeout(renderClientDetail, 300);
    }
    
    async function updatePhase(phaseGid, phaseName) {
      if (currentSession) {
        await updateTaskPhase(currentSession.gid, phaseGid);
        currentSession.status = phaseName;
        currentSession.statusGid = phaseGid;
        showToast(`Updated: ${phaseName}`);
        
        const index = sessions.findIndex(s => s.gid === currentSession.gid);
        if (index !== -1) {
          sessions[index] = currentSession;
        }
        
        setTimeout(backToDetail, 300);
      }
    }

    function showAddSubtask() {
  const container = document.getElementById('add-subtask-container');
  const input = document.getElementById('subtask-name-input');
  container.style.display = 'block';
  input.value = '';
  input.focus();
}

function cancelAddSubtask() {
  const container = document.getElementById('add-subtask-container');
  container.style.display = 'none';
}

async function createNewSubtask() {
  const input = document.getElementById('subtask-name-input');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Please enter a task name');
    return;
  }
  
  try {
    await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${currentSession.gid}/subtasks`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${asanaToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        data: {
          name: name,
          completed: false
        }
      })
    });
    
    showToast('Sub-task created!');
    cancelAddSubtask();
    setTimeout(renderClientDetail, 300);
  } catch (error) {
    console.error('Failed to create sub-task:', error);
    showToast('Failed to create sub-task');
  }
}
async function archiveAndHideSubtask(subtaskGid, subtaskName) {
  if (!confirm(`Archive and hide: "${subtaskName}"?`)) return;
  
  try {
    const now = new Date().toLocaleString('en-US', { 
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: '2-digit', hour12: true
    });
    
    // Add comment to parent task
    await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${currentSession.gid}/stories`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('asanaToken')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        data: { text: `‚úì Archived: ${subtaskName} (${now})` }
      })
    });
    
    // Delete the sub-task
    await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${subtaskGid}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('asanaToken')}` }
    });
    
    showToast('Sub-task archived!');
    setTimeout(renderClientDetail, 300);
  } catch (error) {
    console.error('Failed to archive:', error);
    showToast('Failed to archive sub-task');
  }
}
async function archiveAndHideSubtask(subtaskGid, subtaskName) {
  if (!confirm(`Archive and hide: "${subtaskName}"?`)) return;
  
  try {
    // Create timestamp
    const now = new Date();
    const timestamp = now.toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
    
    // Add comment to parent task with archived sub-task info
    const archiveNote = `‚úì Completed & Archived: ${subtaskName} (${timestamp})`;
    
    await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${currentSession.gid}/stories`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${asanaToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        data: {
          text: archiveNote
        }
      })
    });
    
    // Delete the sub-task from Asana
    await fetch(`https://d.rook-bb4.workers.dev?path=/tasks/${subtaskGid}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${asanaToken}`
      }
    });
    
    showToast('Sub-task archived!');
    setTimeout(renderClientDetail, 300);
  } catch (error) {
    console.error('Failed to archive sub-task:', error);
    showToast('Failed to archive sub-task');
  }
}
    
    function formatDate(dateString) {
      if (!dateString) return 'No date set';
      const date = new Date(dateString);
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
    }
    
    function showAddClient() {
      document.getElementById('add-client-modal').classList.add('active');
      document.getElementById('client-name').focus();
    }
    
    
    function toggleInquiryNotes() {
      const section = document.getElementById('inquiry-section');
      const icon = document.getElementById('inquiry-toggle');
      section.classList.toggle('expanded');
      icon.classList.toggle('expanded');
    }
    
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId + '-section');
      const icon = document.getElementById(sectionId + '-toggle');
      section.classList.toggle('expanded');
      icon.classList.toggle('expanded');
    }
    
    async function init() {
      if (!asanaToken) {
        showTokenModal();
        return;
      }
      await renderWidget();
    }
    
    
    init();
  </script>
</body>
</html>
