<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D4AF37">
  <link rel="manifest" href="manifest.json">
  <title>Photography Sessions</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --text-primary: #F5F5DC;
      --gold: #D4AF37;
      --text-muted: #999999;
      --critical: #FF4444;
      --limited: #FF8C00;
      --available: #7CB342;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
    }
    
    .view {
      display: none;
      min-height: 100vh;
      padding: 16px;
    }
    
    .view.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    #widget-view {
      padding: 20px 16px;
    }
    
    .widget-header {
      margin-bottom: 16px;
    }
    
    .widget-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }
    
    .widget-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    #widget-sessions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    
    .card:active {
      transform: scale(0.98);
      background: #333;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    
    .card-client {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .card-countdown {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
      white-space: nowrap;
    }
    
    .card-info {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    
    .card-date {
      font-size: 14px;
      color: var(--gold);
      font-weight: 500;
    }
    
    .widget-footer {
      margin-top: 16px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }
    
    .list-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
    }
    
    .btn-add {
      background: var(--gold);
      color: var(--bg-primary);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-add:active {
      opacity: 0.8;
    }
    
    .filter-bar {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .filter-bar::-webkit-scrollbar {
      display: none;
    }
    
    .filter-select {
      background: var(--bg-primary);
      border: 1px solid #333;
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--gold);
    }
    
    .filter-select option {
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .list-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .list-item:active {
      background: #333;
    }
    
    .list-item-left h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .list-item-left p {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .list-item-right {
      text-align: right;
      font-size: 12px;
      font-weight: 600;
    }
    
    .detail-header {
      margin-bottom: 20px;
    }
    
    .back-btn {
      background: transparent;
      border: none;
      color: var(--gold);
      font-size: 15px;
      padding: 8px 0;
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .back-btn:active {
      opacity: 0.7;
    }
    
    .detail-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .detail-header .date {
      font-size: 14px;
      color: var(--gold);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .info-card {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .info-card:active {
      background: #333;
    }
    
    .info-card.non-tappable {
      cursor: default;
    }
    
    .info-card.non-tappable:active {
      background: var(--bg-secondary);
    }
    
    .info-card-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .info-card-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 12px;
    }
    
    .todo-item {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .todo-item:active {
      background: #333;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    

    .toast.error {
      background: var(--critical);
      color: #fff;
    }
    
    .form-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1002;
      padding: 20px;
      overflow-y: auto;
    }
    
    .form-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .form-container {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .form-header h2 {
      font-size: 20px;
      color: var(--gold);
    }
    
    .close-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:active {
      opacity: 0.7;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .form-group label .required {
      color: var(--critical);
    }
    
    .form-input,
    .form-select {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid #333;
      color: var(--text-primary);
      padding: 12px;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
    }
    
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--gold);
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath fill='%23999' d='M0 0l6 8 6-8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-primary,
    .btn-secondary {
      flex: 1;
      padding: 14px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    
    .btn-primary {
      background: var(--gold);
      color: var(--bg-primary);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid #333;
    }
    
    .btn-primary:active,
    .btn-secondary:active {
      opacity: 0.7;
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .error-text {
      color: var(--critical);
      font-size: 12px;
      margin-top: 4px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    .spinner {
      border: 3px solid #333;
      border-top: 3px solid var(--gold);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
    }
    
    .modal-content h3 {
      color: var(--gold);
      margin-bottom: 12px;
      font-size: 18px;
    }
    
    .modal-content p {
      color: var(--text-muted);
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .modal-content input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid #333;
      color: var(--text-primary);
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .modal-content button {
      width: 100%;
      background: var(--gold);
      color: var(--bg-primary);
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .modal-content button:active {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  
  <div class="modal" id="token-modal">
    <div class="modal-content">
      <h3>Enter Asana Token</h3>
      <p>Token is stored locally and only sent to Asana's API.</p>
      <input type="password" id="token-input" placeholder="Paste your Asana token">
      <button onclick="saveToken()">Save Token</button>
    </div>
  </div>
  
  <div class="view active" id="widget-view">
    <div class="widget-header" style="cursor: pointer;" onclick="showList()">
      <h1>Photography Sessions</h1>
      <div class="widget-subtitle">Tap to manage</div>
    </div>
    
    <div class="filter-bar">
      <select class="filter-select" id="widget-filter-phase" onchange="applyFiltersWidget()">
        <option value="">All Phases</option>
      </select>
      <select class="filter-select" id="widget-filter-type" onchange="applyFiltersWidget()">
        <option value="">All Types</option>
      </select>
      <select class="filter-select" id="widget-filter-payment" onchange="applyFiltersWidget()">
        <option value="">All Payments</option>
        <option value="Paid">Paid</option>
        <option value="Partial">Partial</option>
        <option value="Unpaid">Unpaid</option>
      </select>
    </div>
    
    <div id="widget-sessions">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading...</div>
      </div>
    </div>
    <div class="widget-footer" id="widget-footer">Updated --:--</div>
  </div>
  
  <div class="view" id="list-view">

  <!-- Add Client Form Modal -->
  <div id="add-client-modal" class="form-modal">
    <div class="form-container">
      <div class="form-header">
        <h2>New Client</h2>
        <button class="close-btn" onclick="hideAddClient()">&times;</button>
      </div>
      <form id="add-client-form" onsubmit="createClient(event)">
        <div class="form-group">
          <label>Client Name <span class="required">*</span></label>
          <input type="text" id="client-name" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label>Session Type <span class="required">*</span></label>
          <select id="session-type" class="form-select" required>
            <option value="">Select type...</option>
            <option value="1211733368712826">📋 Client</option>
            <option value="1211733368712827">💎 Luxury Client</option>
            <option value="1211733368712828">✈️ Destination Client</option>
            <option value="1211733368712829">🤝 Collab</option>
            <option value="1211733368712830">🎉 Event Client</option>
            <option value="1211733368712831">🏢 Brand Affiliates</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Session Date <span class="required">*</span></label>
          <input type="date" id="session-date" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label>Phase <span class="required">*</span></label>
          <select id="client-phase" class="form-select" required>
            <option value="">Select phase...</option>
            <option value="1211735634914714">Phase I - Inquiry</option>
            <option value="1211735634914715">Phase II - Discovery</option>
            <option value="1211735634914716">Phase III - Planning</option>
            <option value="1211735634914717">Phase IV - Shoot Day</option>
            <option value="1211735634914718">Phase V - Post-Production</option>
            <option value="1211735634914719">Phase VI - Archiving</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Payment Status</label>
          <select id="payment-status" class="form-select">
            <option value="1211733390060958">Unpaid</option>
            <option value="1211733390060959">Partial</option>
            <option value="1211733390060960">Paid</option>
          </select>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="hideAddClient()">Cancel</button>
          <button type="submit" class="btn-primary" id="submit-btn">Create Client</button>
        </div>
      </form>
    </div>
  </div>

    <div class="list-header">
      <h2>Photography Sessions</h2>
      <button class="btn-add" onclick="showAddClient()">+ New</button>
    </div>
    
    <div class="filter-bar">
      <select class="filter-select" id="filter-phase" onchange="applyFilters()">
        <option value="">All Phases</option>
      </select>
      <select class="filter-select" id="filter-type" onchange="applyFilters()">
        <option value="">All Types</option>
      </select>
      <select class="filter-select" id="filter-payment" onchange="applyFilters()">
        <option value="">All Payments</option>
        <option value="Paid">Paid</option>
        <option value="Partial">Partial</option>
        <option value="Unpaid">Unpaid</option>
      </select>
    </div>
    
    <div id="client-list"></div>
  </div>
  
  <div class="view" id="detail-view">
    <div class="detail-header">
      <button class="back-btn" onclick="backToList()"><- Back to Clients</button>
      <h2 id="detail-client-name">Client</h2>
      <div class="date" id="detail-session-date">Date</div>
    </div>
    
    <div class="info-grid">
      <div class="info-card" onclick="showPhaseSelector()">
        <div class="info-card-label">Current Phase</div>
        <div class="info-card-value" id="detail-phase">-</div>
      </div>
      <div class="info-card non-tappable">
        <div class="info-card-label">Payment</div>
        <div class="info-card-value" id="detail-payment">-</div>
      </div>
    </div>
    
    <div class="section-title">To-Do Items</div>
    <div id="detail-todos"></div>
  </div>
  
  <div class="view" id="phase-view">
    <div class="detail-header">
      <button class="back-btn" onclick="backToDetail()"><- Back</button>
      <h2>Select Phase</h2>
      <div class="date" id="phase-client-name">Client</div>
    </div>
    <div id="phase-list"></div>
  </div>
  
  <script>
    const PROJECT_ID = "1211733193402684";
    const FIELD_IDS = {
      clientPhase: "1211735634914711",
      sessionDate: "1211732464258476",
      activeStatus: "1211735138096716",
      sessionType: "1211733359641772",
      paymentStatus: "1211733390060955"
    };
    const ACTIVE_GREEN_GID = "1211735138096720";
    
    let sessions = [];
    let currentSession = null;
    let phaseOptions = [];
    let asanaToken = localStorage.getItem('asanaToken');
    
    // Filter state
    let currentFilters = {
      phase: '',
      type: '',
      payment: ''
    };
    
    async function asanaRequest(endpoint, options = {}) {
      if (!asanaToken) {
        showTokenModal();
        return null;
      }
      
      try {
        const response = await fetch(`https://app.asana.com/api/1.0${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${asanaToken}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            showToast('Invalid token');
            showTokenModal();
            return null;
          }
          throw new Error(`API error: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        showToast('Connection error');
        return null;
      }
    }
    
    
    function hideAddClient() {
      document.getElementById('add-client-modal').classList.remove('active');
      document.getElementById('add-client-form').reset();
    }
    
    async function createClient(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';
      
      try {
        const clientName = document.getElementById('client-name').value.trim();
        const sessionTypeGid = document.getElementById('session-type').value;
        const sessionDate = document.getElementById('session-date').value;
        const phaseGid = document.getElementById('client-phase').value;
        const paymentStatusGid = document.getElementById('payment-status').value;
        
        // Get session type name
        const sessionTypeSelect = document.getElementById('session-type');
        const sessionTypeName = sessionTypeSelect.options[sessionTypeSelect.selectedIndex].text;
        
        const taskData = {
          data: {
            name: `${clientName} - ${sessionTypeName}`,
            projects: [PROJECT_ID],
            custom_fields: {
              [SESSION_TYPE_FIELD_ID]: sessionTypeGid,
              [SESSION_DATE_FIELD_ID]: sessionDate,
              [CLIENT_PHASE_FIELD_ID]: phaseGid,
              [PAYMENT_STATUS_FIELD_ID]: paymentStatusGid,
              [ACTIVE_STATUS_FIELD_ID]: '1211735138096720' // 🟢 Green (Active)
            }
          }
        };
        
        const response = await fetch('https://app.asana.com/api/1.0/tasks', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${asanaToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(taskData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.errors?.[0]?.message || 'Failed to create client');
        }
        
        hideAddClient();
        showToast('Client created!');
        
        // Refresh data
        await renderWidget();
        
      } catch (error) {
        console.error('Create client error:', error);
        showToast(error.message, true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Client';
      }
    }
      
      if (task.custom_fields) {
        for (const field of task.custom_fields) {
          if (field.gid === FIELD_IDS.clientPhase && field.enum_value) {
            session.status = field.enum_value.name;
            session.statusGid = field.enum_value.gid;
          } else if (field.gid === FIELD_IDS.sessionDate) {
            // Asana date fields can be: field.date_value.date OR field.date_value (string)
            const dateValue = field.date_value?.date || field.date_value;
            if (dateValue) {
              session.sessionDate = dateValue;
              session.countdown = calculateCountdown(dateValue);
            }
          } else if (field.gid === FIELD_IDS.activeStatus && field.enum_value) {
            session.isActive = field.enum_value.gid === ACTIVE_GREEN_GID;
          } else if (field.gid === FIELD_IDS.sessionType && field.multi_enum_values) {
            if (field.multi_enum_values.length > 0) {
              session.sessionType = field.multi_enum_values.map(v => v.name).join(', ');
            }
          } else if (field.gid === FIELD_IDS.paymentStatus && field.enum_value) {
            session.paymentStatus = field.enum_value.name;
          }
        }
      }
      
      return session;
    }
    
    function calculateCountdown(dateString) {
      if (!dateString) return { text: 'No date', days: 999, color: 'var(--text-muted)' };
      
      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const sessionDate = new Date(dateString);
      
      // Check for invalid date
      if (isNaN(sessionDate.getTime())) {
        return { text: 'Invalid date', days: 999, color: 'var(--text-muted)' };
      }
      
      sessionDate.setHours(0, 0, 0, 0);
      const days = Math.ceil((sessionDate - now) / (1000 * 60 * 60 * 24));
      
      let text, color;
      
      if (days < 0) {
        text = `${Math.abs(days)}d overdue`;
        color = 'var(--critical)';
      } else if (days === 0) {
        text = 'TODAY';
        color = 'var(--critical)';
      } else if (days === 1) {
        text = 'Tomorrow';
        color = 'var(--critical)';
      } else if (days <= 7) {
        text = `${days} days`;
        color = days <= 2 ? 'var(--critical)' : 'var(--limited)';
      } else if (days <= 30) {
        text = `${days} days`;
        color = 'var(--available)';
      } else {
        const months = Math.floor(days / 30);
        text = `${months}mo`;
        color = 'var(--available)';
      }
      
      return { text, days, color };
    }
    
    async function fetchTodos(taskGid) {
      const response = await asanaRequest(
        `/tasks/${taskGid}/subtasks?opt_fields=name,completed,gid`
      );
      return response?.data || [];
    }
    
    async function fetchPhaseOptions() {
      const response = await asanaRequest(
        `/custom_fields/${FIELD_IDS.clientPhase}`
      );
      return response?.data?.enum_options || [];
    }
    
    async function updateTaskPhase(taskGid, phaseGid) {
      await asanaRequest(`/tasks/${taskGid}`, {
        method: 'PUT',
        body: JSON.stringify({
          data: {
            custom_fields: {
              [FIELD_IDS.clientPhase]: phaseGid
            }
          }
        })
      });
    }
    
    async function completeTask(taskGid) {
      await asanaRequest(`/tasks/${taskGid}`, {
        method: 'PUT',
        body: JSON.stringify({
          data: { completed: true }
        })
      });
    }
    
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }
    
    function showList() {
      showView('list-view');
      // Small delay to ensure DOM is ready
      setTimeout(() => {
        populateFilterDropdowns();
        renderClientList();
      }, 50);
    }
    
    async function showDetail(sessionGid) {
      currentSession = sessions.find(s => s.gid === sessionGid);
      showView('detail-view');
      await renderClientDetail();
    }
    
    async function showPhaseSelector() {
      if (phaseOptions.length === 0) {
        phaseOptions = await fetchPhaseOptions();
      }
      showView('phase-view');
      renderPhaseSelector();
    }
    
    function backToList() {
      showList();
    }
    
    function backToDetail() {
      showView('detail-view');
    }
    
    function showAddClient() {
      showToast('Quick add coming in Phase 5');
    }
    
    function showTokenModal() {
      document.getElementById('token-modal').classList.add('active');
    }
    
    function saveToken() {
      const token = document.getElementById('token-input').value.trim();
      if (token) {
        localStorage.setItem('asanaToken', token);
        asanaToken = token;
        document.getElementById('token-modal').classList.remove('active');
        init();
      }
    }
